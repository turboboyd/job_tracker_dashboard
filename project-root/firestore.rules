rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    function isSelf(userId) { return signedIn() && uid() == userId; }

    // =========================
    // Root user doc (compat)
    // =========================
    match /users/{userId} {
      allow read: if isSelf(userId);
      allow create, update: if isSelf(userId);
      allow delete: if false;

      // -------------------------
      // Loops (legacy)
      // -------------------------
      match /loops/{loopId} {
        allow read, create, update, delete: if isSelf(userId);
      }

      // -------------------------
      // loopMatches (legacy) â€” must stay enabled
      // -------------------------
      match /loopMatches/{matchId} {
        allow read, create, update, delete: if isSelf(userId);
      }

      // -------------------------
      // Applications (new)
      // -------------------------
      match /applications/{appId} {
        allow read, create, update, delete: if isSelf(userId);

        // History subcollection (used by details page)
        match /history/{historyId} {
          allow read, create: if isSelf(userId);
          allow update, delete: if false;
        }
      }

      // Optional schema collections
      match /cv_versions/{cvId} {
        allow read, create, update: if isSelf(userId);
        allow delete: if false;
      }

      match /private/{docId} {
        allow read, create, update, delete: if isSelf(userId);
      }

      match /profile_versions/{pvId} {
        allow read: if isSelf(userId);
        allow create, update, delete: if false;
      }

      match /stats/{statId} {
        allow read: if isSelf(userId);
        allow create, update, delete: if false;
      }
    }

    // Public aggregated stats
    match /publicStats/{docId} {
      allow read: if true;
      allow write: if false;
    }
  }
}
